<?php
use Magento\Framework\Escaper;
use Magento\LayeredNavigation\ViewModel\Layer\Filter;

/** @var \Gopersonal\Magento\Block\Navigation\FilterRenderer $block */
/** @var Escaper $escaper */
/** @var Filter $viewModel */

$viewModel = $block->getData('product_layer_view_model');
$mageVersion = $block->getVersion();
$filterCounts = $block->getFilterCounts();
$filterData = $block->getFilterData();

// Initialize locale formatter if needed (Magento 2.4.5+)
$localeFormatter = null;
if ($mageVersion && version_compare($mageVersion, "2.4.5", '>')) {
    $localeFormatter = $block->getLocaleFormatter();
}

// Logging filter data and filter counts
$logger = $block->getLogger();
$logger->info('Filter Counts: ' . json_encode($filterCounts));
$logger->info('Filter Data: ' . json_encode($filterData));

?>

<div class="sidebar sidebar-main">
    <div class="block filter">
        <div class="block-title filter-title">
            <strong>Shop By</strong>
        </div>
        <div class="block-content filter-content">
            <strong role="heading" aria-level="2" class="block-subtitle filter-subtitle">Shopping Options</strong>
            <dl class="filter-options" id="narrow-by-list">
                <?php if ($filterData && $filterCounts): ?>
                    <?php foreach ($filterData as $attributeCode => $options): ?>
                        <?php
                        // Log each attribute code and options
                        $logger->info('Attribute Code: ' . $attributeCode);
                        $logger->info('Options: ' . json_encode($options));
                        ?>
                        <dt role="heading" aria-level="3" class="filter-options-title">
                            <?= $escaper->escapeHtml(ucwords(str_replace('_', ' ', $attributeCode))) ?>
                        </dt>
                        <dd class="filter-options-content">
                            <ol class="items">
                                <?php foreach ($options as $value => $label): ?>
                                    <?php
                                    $filterCount = isset($filterCounts[$attributeCode][$value]) ? $filterCounts[$attributeCode][$value] : 0;
                                    // Log each filter item and its count
                                    $logger->info('Filter Item: ' . $label . ' (' . $value . ') has count: ' . $filterCount);
                                    ?>
                                    <li class="item">
                                        <?php if ($filterCount > 0): ?>
                                            <a href="#" rel="nofollow">
                                                <?= $escaper->escapeHtml($label) ?>
                                                <?php if ($viewModel->shouldDisplayProductCountOnLayer()): ?>
                                                    <span class="count">
                                                        <?php if ($localeFormatter): ?>
                                                            <?= $escaper->escapeHtml($localeFormatter->formatNumber($filterCount)) ?>
                                                        <?php else: ?>
                                                            <?= $escaper->escapeHtml($filterCount) ?>
                                                        <?php endif; ?>
                                                        <span class="filter-count-label">
                                                            <?= $escaper->escapeHtml(__($filterCount == 1 ? 'item' : 'items')) ?>
                                                        </span>
                                                    </span>
                                                <?php endif; ?>
                                            </a>
                                        <?php else: ?>
                                            <span class="item-label"><?= $escaper->escapeHtml($label) ?></span>
                                            <?php if ($viewModel->shouldDisplayProductCountOnLayer()): ?>
                                                <span class="count">
                                                    <?php if ($localeFormatter): ?>
                                                        <?= $escaper->escapeHtml($localeFormatter->formatNumber($filterCount)) ?>
                                                    <?php else: ?>
                                                        <?= $escaper->escapeHtml($filterCount) ?>
                                                    <?php endif; ?>
                                                    <span class="filter-count-label">
                                                        <?= $escaper->escapeHtml(__('items')) ?>
                                                    </span>
                                                </span>
                                            <?php endif; ?>
                                        <?php endif; ?>
                                    </li>
                                <?php endforeach; ?>
                            </ol>
                        </dd>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p>No filter options available.</p>
                <?php endif; ?>
            </dl>
        </div>
    </div>
</div>
